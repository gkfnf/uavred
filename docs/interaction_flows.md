# 交互流程设计

## 概述

本文档详细说明 UAVRED 应用中 5+ 个核心交互场景的完整用户流程和系统行为。

---

## Flow 1: 创建并启动扫描任务

### 用户目标
在 Scan 模块中配置扫描参数，选择目标，并启动网络扫描。

### 流程步骤

```
1. 用户点击 Navigation Bar 中的 [Scan] Tab
   → 加载 Scan 配置界面
   → 显示骨架屏 (200ms)
   → 加载完成，显示扫描表单

2. 用户选择目标设备
   ☐ mavic-3-pro-v2     ← 用户点击 checkbox
   ☑ mavic-3-pro-v2     ← 状态变化 (200ms 过渡)
   ☐ phantom-4-pro
   ☑ phantom-4-pro
   
   系统行为:
   - 即时更新 checkbox 状态
   - 下方显示 "已选择 2 个设备"

3. 用户选择扫描类型
   ☐ Network Scan
   ○ Protocol Analysis    ← 用户点击 radio
   ● Protocol Analysis    ← 状态变化
   ☐ Firmware Analysis
   
   系统行为:
   - Radio button 只能单选
   - 显示该类型的说明文字

4. 用户配置扫描选项
   ☑ Deep Inspection       ← 已启用
   ☑ Exploit Verification  ← 已启用
   ☐ Generate Report       ← 用户点击启用
   ☑ Generate Report
   
   系统行为:
   - Toggle 立即反馈
   - 可选项下方显示细化配置

5. 用户预览扫描配置
   点击 [预览] 按钮
   
   系统行为:
   - 弹出 Modal 框
   - 展示配置总结:
     设备: mavic-3-pro-v2, phantom-4-pro
     类型: Protocol Analysis
     选项: Deep Inspection, Exploit Verification, 生成报告
   - 显示 [编辑] [确认] 按钮

6. 用户保存配置为模板（可选）
   点击 [保存模板] 按钮
   
   系统行为:
   - 弹出 Input Modal
   - 用户输入模板名称 "DJI 设备基础扫描"
   - 点击 [保存]
   - Toast 提示: "✓ 模板已保存 (2s 消失)"

7. 用户启动扫描
   点击 [启动扫描] 按钮 (Primary Button)
   
   系统行为:
   - Button 变为 Disabled
   - 按钮内显示 Loading Spinner
   - 后端创建扫描任务
   - 任务分配给相应 Agent

8. 扫描启动反馈
   - Toast 通知: "✓ 扫描已启动，ID: scan-20241231-001"
   - 界面自动跳转到 Mission Control
   - 新任务卡片出现在 "To Do" 列 (动画进入)
   - Agent Panel 显示 Agent 开始执行

9. 用户监控扫描进度
   - 任务卡片在列间移动: To Do → In Progress
   - Agent Panel 显示实时日志
   - 用户可点击任务卡片查看详情

10. 扫描完成
    - 任务卡片移动到 "Done" 列
    - Findings 列表自动更新，新发现高亮显示
    - Toast 通知: "✓ 扫描完成，发现 3 个高危漏洞"
```

### 关键交互细节

| 步骤 | 交互元素 | 反馈 | 延迟 |
|------|---------|------|------|
| 选择设备 | Checkbox | 状态变化 + 计数更新 | 0ms |
| 预览配置 | Modal | 淡入 + 内容加载 | 200ms |
| 启动扫描 | Button | Loading Spinner | 500ms |
| 切换视图 | Navigation | 淡出→淡入 | 300ms |
| 新卡片出现 | Kanban | 滑入动画 | 200ms |

### 快捷键支持

| 快捷键 | 操作 |
|--------|------|
| `Ctrl+S` | 启动扫描 |
| `Ctrl+T` | 保存模板 |
| `Ctrl+P` | 预览配置 |

---

## Flow 2: 查看和分析漏洞发现

### 用户目标
查看扫描发现的漏洞列表，并详细分析特定漏洞。

### 流程步骤

```
1. 用户点击 Navigation Bar 中的 [Vulns 2] Tab
   → 加载 Findings View
   → 显示发现列表和统计信息

2. 用户查看统计信息
   ┌────────────────────────────┐
   │ Total: 45                   │ ← 用户一眼看到总数
   │ ●Critical: 3  ●High: 8      │ ← 按颜色区分严重程度
   │ ●Medium: 18  ●Low: 16       │
   └────────────────────────────┘

3. 用户按严重程度过滤
   点击 [High] Tab
   
   系统行为:
   - Tab 切换到 High
   - 列表立即过滤，仅显示 High 级别的 8 项
   - 列表顶部闪烁 (可选)
   - 动画: 250ms 平滑过渡

4. 用户搜索特定漏洞
   点击搜索框，输入 "buffer"
   
   系统行为:
   - 输入 "b": 列表还未过滤（等待防抖）
   - 输入 "e": 继续等待
   - 输入 "r": 防抖完成 (300ms)
   - 列表过滤，仅显示标题/描述包含 "buffer" 的项
   - 匹配关键词高亮显示 (紫色背景)
   - 显示匹配计数 "2 项匹配"

5. 用户查看漏洞列表项
   ┌──────────────────────────────────────┐
   │ ● CVE-2024-1234 [CONFIRMED]         │ ← 状态徽章
   │                                      │
   │ MAVLink Buffer Overflow               │
   │ Detected potential buffer overflow... │
   │                                      │
   │ DJI Mavic 3 | 2m ago | High | [►]   │ ← 元数据 + 展开按钮
   └──────────────────────────────────────┘
   
   系统行为:
   - Hover 效果: 背景亮化，展示快捷菜单
   - 快捷菜单: [详情] [导出] [分享]

6. 用户点击漏洞查看详情
   点击漏洞卡片的 [►] 按钮 或 点击卡片本身
   
   系统行为:
   - 右侧 Drawer 打开 (滑入动画 300ms)
   - 显示详细信息:
     * CVE 编号
     * 漏洞描述
     * CVSS 评分
     * 影响范围
     * 修复建议
     * 相关截图/流量包
   - Drawer 中显示 [关闭] [导出] [添加标签] 按钮

7. 用户添加标签
   点击 [添加标签] 按钮
   
   系统行为:
   - Drawer 下方出现 Tag 输入框
   - 用户输入 "privilege-escalation"
   - 按 Enter 确认
   - Tag 立即显示在列表中
   - 返回列表时，标签也显示在卡片上

8. 用户导出漏洞报告
   点击 [导出] 按钮
   
   系统行为:
   - Dropdown 菜单: [PDF] [CSV] [JSON]
   - 用户选择 [PDF]
   - 后台生成报告 (显示 Progress Bar)
   - 下载链接出现
   - 下载完成后 Toast: "✓ 报告已导出"

9. 用户返回列表
   点击 Drawer 的 [关闭] 按钮 或 按 ESC 键
   
   系统行为:
   - Drawer 滑出 (300ms)
   - 焦点回到列表
   - 页面位置保持不变
```

### 关键交互细节

| 步骤 | 交互元素 | 反馈 | 延迟 |
|------|---------|------|------|
| 过滤 Tab | Tab 组件 | 列表即时更新 | 0ms |
| 搜索 | Input + 防抖 | 高亮 + 计数 | 300ms |
| Hover 卡片 | ListItem | 显示快捷菜单 | 0ms |
| 打开详情 | Drawer | 滑入 + 加载 | 300ms |
| 添加标签 | Input | Tag 出现 | 0ms |
| 导出 | Dropdown | 文件下载 | 变量 |

### 快捷键支持

| 快捷键 | 操作 |
|--------|------|
| `F` | 过滤/搜索 |
| `E` | 导出当前结果 |
| `T` | 添加标签 |
| `ESC` | 关闭详情面板 |
| `↑↓` | 在列表中上下移动 |

---

## Flow 3: 编排 Kanban 看板任务

### 用户目标
在 Mission Control 中创建任务、拖拽卡片改变状态、批量操作。

### 流程步骤

```
1. 用户进入 Mission Control 视图
   → Dashboard Tab (默认)
   → 显示三列 Kanban 看板

2. 用户创建新任务
   点击 "To Do" 列的 [+] 按钮
   
   系统行为:
   - 列顶部弹出快速输入框
   - 光标自动聚焦
   - 用户输入任务标题: "Analyze DJI Protocol"
   - 按 Enter 或 点击 [✓] 确认
   - 新卡片在列顶部出现 (动画进入)
   - Toast: "✓ 任务已创建"

3. 用户点击卡片编辑详情
   点击新创建的卡片
   
   系统行为:
   - 右侧 Drawer 打开
   - 显示任务编辑表单:
     * 标题
     * 描述
     * 优先级 (Dropdown)
     * 任务类型 (Dropdown)
     * 指派给 (User Selector)
     * 标签 (Tag Input)
     * 截止日期 (DatePicker)
   - 所有修改立即保存（Auto-save）
   - 列表中的卡片实时更新

4. 用户拖拽卡片改变状态
   用户在 "To Do" 列的卡片上按下鼠标
   
   系统行为:
   - 卡片变为半透明 (opacity 70%)
   - 其他卡片向下移动，显示 Drop Zone
   
   用户拖拽到 "In Progress" 列
   
   系统行为:
   - Drop Zone 出现在目标列
   - Drop Zone 变为紫色高亮
   
   用户释放鼠标
   
   系统行为:
   - 卡片平滑滑入目标列
   - 卡片状态更新
   - 其他列的卡片重新排列
   - 后端保存状态变化
   - Toast: "✓ 任务已移至 In Progress"

5. 用户在列内重新排序
   拖拽 "In Progress" 列的卡片向上
   
   系统行为:
   - 卡片移动到新位置
   - 其他卡片自动调整
   - 动画过渡: 200ms
   - 优先级顺序更新

6. 用户完成任务
   拖拽卡片到 "Done" 列
   
   系统行为:
   - 卡片滑出原列 (淡出 200ms)
   - 卡片滑入 "Done" 列 (淡入 200ms)
   - 卡片样式变化（可选：变灰或加删除线）
   - 列的计数更新
   - Toast: "✓ 任务已完成"

7. 用户快速菜单操作
   右键点击卡片
   
   系统行为:
   - Context Menu 出现
   - 选项:
     [编辑]
     [复制]
     [移到顶部]
     [优先级...] → Sub Menu
     [分配给...] → Sub Menu
     [删除]

8. 用户选择多个任务（批量）
   按 Ctrl 并点击多个卡片
   
   系统行为:
   - 已选卡片背景变为紫色
   - 顶部出现批量操作栏:
     [已选择 3 项] [优先级] [分配] [标签] [删除]

9. 用户批量操作
   在批量选择状态下，点击 [优先级]
   
   系统行为:
   - Dropdown 菜单出现
   - 用户选择 "Critical"
   - 所有 3 个卡片的优先级更新
   - Toast: "✓ 已更新 3 项任务"
   - 批量选择解除

10. 用户应用任务模板
    点击 "To Do" 列的 [模板库]
    
    系统行为:
    - Modal 打开，显示保存的模板列表
    - 用户选择 "DJI 基础测试流程"
    - 确认应用
    - 模板中的多个任务一次性添加到列中
    - Toast: "✓ 已添加 5 个模板任务"
```

### 关键交互细节

| 步骤 | 交互元素 | 反馈 | 延迟 |
|------|---------|------|------|
| 创建任务 | 快速输入 | 卡片进入 | 0ms |
| 编辑任务 | Drawer | 打开 + 自动保存 | 300ms |
| 拖拽卡片 | Drag & Drop | 实时高亮 | 0ms |
| 释放卡片 | Drop | 平滑移动 | 200ms |
| 右键菜单 | Context Menu | 立即显示 | 0ms |
| 批量操作 | Batch Toolbar | 淡入 | 200ms |
| 应用模板 | Modal | 快速插入 | 300ms |

### 快捷键支持

| 快捷键 | 操作 |
|--------|------|
| `Ctrl+N` | 新建任务 |
| `Ctrl+D` | 删除选中任务 |
| `Ctrl+A` | 全选（当前列） |
| `→` | 右移任务（下一列） |
| `←` | 左移任务（上一列） |

---

## Flow 4: 实时监控 Agent 执行

### 用户目标
观察 Agent 的实时执行状态、日志和工具调用。

### 流程步骤

```
1. Agent 开始执行任务
   系统自动:
   - Agent Panel 出现在右侧 (已收起)
   - 显示 "🤖 Network Scanner 🔴 LIVE TRACE"
   - 面板自动展开 (滑入 300ms)

2. Agent 显示 Mission Objective
   系统显示:
   ┌─────────────────────────────┐
   │ 🎯 Scan mavic-3 for         │
   │    open MAVLink port        │
   └─────────────────────────────┘

3. Agent 执行日志逐条出现
   ⚪ [14:23:12] HISTORY
      Received task from scheduler
   
   系统行为:
   - 日志条目自上而下出现 (动画进入 100ms)
   - 每条日志都是新的一行
   - 日志类型用 emoji 和颜色区分
   - 时间戳固定宽度 (等宽字体)

4. Agent 进行思考
   💭 [14:23:14] THOUGHT
      Attempting port scan on target 192.168.1.100
      Port 14550 commonly used by MAVLink protocol
   
   系统行为:
   - 紫色高亮 (💭 emoji)
   - 可能是多行文字

5. Agent 制定计划
   📋 [14:23:15] PLAN
      1. Send SYN probe to port 14550
      2. If open, analyze MAVLink handshake
      3. Extract protocol version
   
   系统行为:
   - 黄色高亮 (📋 emoji)
   - 多行文字格式

6. Agent 调用工具
   🔧 [14:23:16] TOOL
      nmap -sS -p 14550 192.168.1.100
   
   系统行为:
   - 蓝色高亮 (🔧 emoji)
   - 显示命令行格式

7. 工具执行和反馈
   > nmap -sS -p 14550 192.168.1.100
   ┌─────────────────────────────────┐
   │ Connected to TCP port 14550      │  ← 工具输出
   │ Sent 1 bytes                     │
   │ Received 32 bytes                │
   │ Service Version: MAVLink 2.0     │
   └─────────────────────────────────┘
   ✓ Success (145ms)                     ← 执行状态
   
   系统行为:
   - 工具执行时显示进度
   - 完成时显示执行时间
   - 成功显示 ✓ 绿色
   - 失败显示 ✗ 红色

8. Agent 继续执行下一步
   🔧 [14:23:17] TOOL
      craft_mavlink_heartbeat --target 192.168.1.100:14550
   
   > craft_mavlink_heartbeat --target 192.168.1.100:14550
   [⏳] Running...                      ← 进行中
   
   系统行为:
   - Spinner 显示执行中
   - 进度 Bar 显示进度（如果支持）

9. 用户暂停 Agent 执行
   点击 Agent Panel 的 [暂停] 按钮
   
   系统行为:
   - 按钮变为 [继续] 
   - Agent 当前工具继续运行完毕
   - 后续任务暂停
   - Toast: "⏸ Agent 已暂停"

10. 用户恢复执行
    点击 [继续] 按钮
    
    系统行为:
    - Agent 恢复执行
    - 按钮变回 [暂停]
    - Toast: "▶ Agent 已恢复"

11. 用户停止 Agent
    点击 [停止] 按钮
    
    系统行为:
    - 确认对话框: "确定要停止执行吗？"
    - 用户确认
    - Agent 立即停止
    - 面板显示 "🔴 STOPPED"
    - Toast: "⏹ Agent 已停止"

12. Agent 执行完成
    系统自动:
    - 最后一条日志: ⚪ [14:24:32] HISTORY
                     Task completed
    - Agent Panel 显示 "🟢 COMPLETED"
    - 显示执行摘要:
      * 执行时间: 1min 20s
      * 工具调用: 5 次
      * 成功: 4 / 失败: 1
    - 任务卡片在 Kanban 中更新为 "Done"
    - Toast: "✓ Agent 已完成任务"

13. 用户查看完整日志
    点击 Agent Panel 的 [展开] 按钮
    
    系统行为:
    - Agent Panel 全屏显示（或扩大到 50% 宽度）
    - 显示完整日志历史
    - 支持搜索、导出、复制

14. 用户导出执行记录
    点击 [导出日志] 按钮
    
    系统行为:
    - 菜单: [纯文本] [JSON] [Markdown]
    - 用户选择 [JSON]
    - 下载文件: agent-trace-20241231-001.json
    - Toast: "✓ 日志已导出"
```

### 关键交互细节

| 步骤 | 交互元素 | 反馈 | 延迟 |
|------|---------|------|------|
| Panel 展开 | Auto-expand | 滑入 | 300ms |
| 日志出现 | Append Log | 新行 + 颜色 | 100ms |
| 工具执行 | Tool Run | Spinner | 0ms |
| 工具完成 | Tool Complete | 状态 + 时间 | 0ms |
| 暂停/继续 | Button | 状态改变 | 200ms |
| 停止 | Confirm Dialog | 对话框 | 300ms |

### 快捷键支持

| 快捷键 | 操作 |
|--------|------|
| `Space` | 暂停/继续 |
| `Ctrl+X` | 停止 Agent |
| `Ctrl+L` | 显示日志 |
| `Ctrl+E` | 导出日志 |

---

## Flow 5: 资产管理和设备配置

### 用户目标
添加新设备、配置扫描参数、管理设备分组。

### 流程步骤

```
1. 用户进入 Assets 模块
   点击 Navigation Bar 的 [Assets] Tab
   
   系统行为:
   - 加载资产列表
   - 显示已知设备列表
   - 右上角显示 [+ 新增设备] 按钮

2. 用户添加新设备
   点击 [+ 新增设备] 按钮
   
   系统行为:
   - Modal 弹出: "新增设备"
   - 显示表单:
     * 设备名称 (Input)
     * 设备类型 (Dropdown: UAV, Router, etc.)
     * IP 地址 (Input with validation)
     * 协议 (Dropdown: MAVLink, DJI, etc.)
     * 凭证 (Input, 可选)
   - [取消] [保存] 按钮

3. 用户填写设备信息
   用户输入:
   - 设备名称: "DJI Mini 3 Pro"
   - 设备类型: UAV
   - IP: 192.168.1.102
   - 协议: DJI
   
   系统行为:
   - IP 地址输入框实时验证
   - 协议 Dropdown 根据设备类型自动筛选
   - 保存按钮在信息有效时才启用

4. 用户测试连接
   点击 [测试连接] 按钮（可选）
   
   系统行为:
   - 按钮显示 Loading Spinner
   - 后端向设备发送 ping 或握手包
   - 成功: ✓ 连接成功 (绿色 Alert)
   - 失败: ✗ 无法连接 (红色 Alert)
   - 用户可继续或修改配置

5. 用户保存设备
   点击 [保存] 按钮
   
   系统行为:
   - Modal 关闭 (淡出 200ms)
   - 新设备添加到列表 (动画进入)
   - 列表重新排序（按类型或字母）
   - Toast: "✓ 设备已添加"

6. 用户查看和编辑设备详情
   点击列表中的设备行
   
   系统行为:
   - 右侧 Drawer 打开
   - 显示详细信息:
     * 基本信息
     * 最近扫描历史
     * 已发现的漏洞
     * 通信日志
   - 编辑按钮 [编辑] [删除] [配置扫描]

7. 用户编辑设备配置
   点击 [编辑] 按钮
   
   系统行为:
   - Drawer 中的字段变为可编辑
   - 修改内容（如 IP、凭证）
   - 点击 [保存]
   - 自动验证新配置
   - Toast: "✓ 设备已更新"

8. 用户配置扫描参数
   点击 [配置扫描] 按钮
   
   系统行为:
   - Modal 打开: "设备扫描配置"
   - 选项:
     ☑ 启用自动扫描
     设置扫描时间表 (Cron 表达式)
     ☐ 启用深度扫描
     ☐ 启用漏洞验证
     ☑ 启用固件分析
   - 保存设备级别的扫描策略

9. 用户创建设备分组
   点击列表上方的 [创建分组] 按钮
   
   系统行为:
   - Input 框出现
   - 用户输入分组名: "DJI 设备"
   - 按 Enter 确认
   - 分组卡片出现在列表顶部

10. 用户分配设备到分组
    拖拽设备到分组卡片
    
    系统行为:
    - 设备条目变为半透明
    - 分组卡片高亮为紫色
    - 释放后，设备添加到分组
    - 设备在列表中缩进显示
    - Toast: "✓ 已添加到分组"

11. 用户批量操作设备
    选择多个设备 (Ctrl + 点击)
    
    系统行为:
    - 批量操作栏出现:
      [已选择 3 个设备] [分配到分组] [设置扫描] [删除]

12. 用户删除设备
    点击 [删除] 按钮
    
    系统行为:
    - 确认对话框: "确定删除该设备？此操作无法撤销。"
    - 用户确认
    - 设备从列表中移除 (淡出 200ms)
    - Toast: "✓ 设备已删除"
```

### 关键交互细节

| 步骤 | 交互元素 | 反馈 | 延迟 |
|------|---------|------|------|
| 新增设备 | Modal | 表单打开 | 300ms |
| 测试连接 | Button | Loading + 结果 | 2000ms |
| 保存设备 | Button | 列表更新 | 0ms |
| 编辑设备 | Drawer | 字段可编辑 | 0ms |
| 创建分组 | Input | 分组卡片 | 0ms |
| 拖拽设备 | Drag & Drop | 高亮 + 移动 | 200ms |
| 删除设备 | Confirm | 对话框 | 300ms |

### 快捷键支持

| 快捷键 | 操作 |
|--------|------|
| `Ctrl+N` | 新增设备 |
| `Ctrl+F` | 搜索设备 |
| `Ctrl+T` | 测试连接 |
| `Delete` | 删除选中 |

---

## 通用交互模式

### 页面加载状态

```
初始状态:
  显示骨架屏 (200ms 后)
  
加载成功:
  淡入内容 (200ms)
  保留滚动位置
  
加载失败:
  显示 Error Alert
  [重试] [返回] 按钮
```

### 数据更新反馈

```
乐观更新:
  - UI 立即反应
  - 后端异步更新
  - 失败时回滚 + Error Toast

实时更新:
  - WebSocket 推送更新
  - UI 高亮变化 (可选)
  - 提供撤销选项 (5 秒内)
```

### 错误处理

```
网络错误:
  ✗ 网络连接失败，请检查您的网络
  [重试] [离线模式]
  
验证错误:
  ✗ Email 格式不正确
  (红色 inline 提示)
  
权限错误:
  ✗ 您没有权限执行此操作
  [联系管理员]
  
服务器错误:
  ✗ 服务器出错了，请稍后重试
  [报告问题] [查看日志]
```

---

## 附录：交互设计检查清单

- ✓ 所有按钮都有 Hover/Active 反馈
- ✓ Loading 状态有清晰指示
- ✓ 错误消息具体和可操作
- ✓ 成功反馈及时和肯定
- ✓ 拖拽/Drop 有清晰的目标指示
- ✓ Modal 和 Drawer 支持 ESC 关闭
- ✓ 表单有实时验证反馈
- ✓ 长操作有取消选项
- ✓ 列表操作支持撤销
- ✓ 关键操作需要确认

